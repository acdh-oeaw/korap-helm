# KorAP Helm Chart

This Helm chart is a **production-ready Kubernetes conversion** of the [KorAP Docker Compose](https://github.com/KorAP/KorAP-Docker) deployment.

KorAP (Corpus Analysis Platform) is a modular system consisting of:
- **Kalamar** - Web-based frontend for corpus search and analysis
- **Kustvakt** - Backend API providing authentication, authorization, and policy management
- **Krill** - Index backend (managed via corpus data in attached volumes)

This chart provides flexible, profile-based deployments supporting lite and full configurations.

---

## üöÄ Features

‚úÖ **Complete Docker Compose Conversion**
- All services from the original compose.yaml
- Matching port configuration (Kalamar: 64543, Kustvakt: 8089)
- Correct image repositories (korap/)
- Kubernetes-compatible restart policies

‚úÖ **Profile-Based Deployment**
- **Lite Profile** - Single Kalamar & Kustvakt services (default)
- **Full Profile** - Enterprise setup with authentication plugins, LDAP support, dedicated data volumes
- **Example Profile** - Optional example index container for testing

‚úÖ **Volume Management**
- Shared index volume for lite and full profiles
- Separate data volumes for full profile (Kalamar & Kustvakt)
- Support for existing PVCs or automatic creation

‚úÖ **Production Ready**
- Initialization job for full profile configuration
- Health checks (readiness/liveness probes)
- Security context configuration
- Service accounts
- Optional Ingress support

‚úÖ **Flexible Configuration**
- Extensive values.yaml with 60+ configuration options
- Environment variable support for custom configuration
- Production configuration file support (full profile)

---

## üì¶ Chart Structure

```
korap-helm/
‚îú‚îÄ‚îÄ Chart.yaml
‚îú‚îÄ‚îÄ values.yaml
‚îú‚îÄ‚îÄ README.md
‚îú‚îÄ‚îÄ IMPLEMENTATION.md
‚îî‚îÄ‚îÄ charts/korap/
    ‚îú‚îÄ‚îÄ Chart.yaml
    ‚îú‚îÄ‚îÄ values.yaml
    ‚îú‚îÄ‚îÄ templates/
    ‚îÇ   ‚îú‚îÄ‚îÄ _helpers.tpl
    ‚îÇ   ‚îú‚îÄ‚îÄ serviceaccount.yaml
    ‚îÇ   ‚îú‚îÄ‚îÄ kalamar-deployment.yaml
    ‚îÇ   ‚îú‚îÄ‚îÄ kalamar-full-deployment.yaml
    ‚îÇ   ‚îú‚îÄ‚îÄ kalamar-configmap.yaml
    ‚îÇ   ‚îú‚îÄ‚îÄ kustvakt-deployment.yaml
    ‚îÇ   ‚îú‚îÄ‚îÄ kustvakt-full-deployment.yaml
    ‚îÇ   ‚îú‚îÄ‚îÄ example-index-deployment.yaml
    ‚îÇ   ‚îú‚îÄ‚îÄ full-init-job.yaml
    ‚îÇ   ‚îú‚îÄ‚îÄ pvc-index.yaml
    ‚îÇ   ‚îú‚îÄ‚îÄ pvc-data.yaml
    ‚îÇ   ‚îú‚îÄ‚îÄ pvc-kustvakt-data.yaml
    ‚îÇ   ‚îú‚îÄ‚îÄ ingress.yaml
    ‚îÇ   ‚îî‚îÄ‚îÄ NOTES.txt
```

---

## ‚öôÔ∏è Configuration

All deployment settings are controlled through `values.yaml` in the chart root directory.

### Service Configuration

```yaml
service:
  kalamar:
    port: 64543        # Kalamar web interface port
    type: ClusterIP
  kustvakt:
    port: 8089         # Kustvakt API port
    type: ClusterIP
```

### Volume Configuration

```yaml
indexVolume:
  size: 10Gi
  storageClassName: null    # Use default storage class
  existingClaim: null       # Or use existing PVC

full:
  dataVolume:
    enabled: false
    mountPath: /kalamar/data
    size: 50Gi
```

### Lite Profile (Default)

```yaml
kalamar:
  image: korap/kalamar:latest
  replicaCount: 1

kustvakt:
  image: korap/kustvakt:latest
```

### Full Profile

```yaml
full:
  enabled: false
  
kalamarFull:
  enabled: false
  image: korap/kalamar:latest

kustvaktFull:
  enabled: false
  image: korap/kustvakt:latest-full
  
# For authentication/LDAP:
full:
  superClientInfoSecretName: null
  kalamarProductionConf:
    enabled: false
    content: ""
```

### Example Profile

```yaml
exampleIndex:
  enabled: false
  image: korap/example-index:0.1
```

### Security & Restart Policies

```yaml
securityContext:
  runAsUser: 0          # Root user (required for full profile)
  runAsGroup: 0
  fsGroup: 0

restartPolicy: Always   # Kubernetes equivalent of Docker's "unless-stopped"
```

---

## üèÅ Installation

### Prerequisites

- Kubernetes 1.16+
- Helm 3.0+
- Sufficient storage for index volumes

### 1. Create Namespace

```bash
kubectl create namespace korap
```

### 2. Install Lite Profile

Basic KorAP deployment:

```bash
helm install korap ./korap \
  --namespace korap \
  --create-namespace
```

### 3. Install Full Profile

Enterprise setup with authentication **(auto-generated by default)**:

```bash
helm install korap ./korap \
  --namespace korap \
  --set full.enabled=true \
  --set kalamarFull.enabled=true \
  --set kustvaktFull.enabled=true \
  --set 'full.dataVolume.enabled=true'
```

**What happens automatically:**
- ‚úÖ OAuth2 `super_client_info` Secret is auto-generated with secure defaults
- ‚úÖ Client secret is 32-character random string
- ‚úÖ Kalamar Auth plugin is automatically enabled
- ‚úÖ Login/authentication ready to use immediately
- ‚úÖ All credentials stored securely in Kubernetes Secret

**To view the generated OAuth credentials:**

```bash
# Get the generated client secret
kubectl get secret korap-korap-super-client-info -o jsonpath='{.data.super_client_info}' -n korap | base64 -d
```

**Customize OAuth Configuration (optional):**

Override auto-generated defaults for your environment:

```bash
helm install korap ./korap \
  --namespace korap \
  --set full.enabled=true \
  --set kalamarFull.enabled=true \
  --set kustvaktFull.enabled=true \
  --set 'full.superClientInfo.clientId=my-korap' \
  --set 'full.superClientInfo.clientName=KorAP Production' \
  --set 'full.superClientInfo.clientRedirectUri=https://korap.example.com/oauth2/callback' \
  --set 'full.superClientInfo.clientSecret=your-custom-secret'
```

**Provide Your Own OAuth Client (optional):**

To use a pre-existing OAuth client configuration:

```bash
# Create secret with your super_client_info file
kubectl create secret generic korap-oauth \
  --from-file=super_client_info=./super_client_info \
  -n korap

# Reference it in deployment
helm install korap ./korap \
  --namespace korap \
  --set full.enabled=true \
  --set kalamarFull.enabled=true \
  --set kustvaktFull.enabled=true \
  --set 'full.superClientInfoSecretName=korap-oauth'
```

**Disable Authentication (optional):**

To run full profile without authentication:

```bash
helm install korap ./korap \
  --namespace korap \
  --set full.enabled=true \
  --set kalamarFull.enabled=true \
  --set kustvaktFull.enabled=true \
  --set 'full.superClientInfo.enabled=false'
```

**Update OAuth Configuration After Deployment:**

Edit the Secret to change credentials:

```bash
# Edit the secret directly
kubectl edit secret korap-korap-super-client-info -n korap

# Or replace it
kubectl delete secret korap-korap-super-client-info -n korap
kubectl create secret generic korap-korap-super-client-info \
  --from-file=super_client_info=/path/to/new/super_client_info \
  -n korap

# Restart Kalamar to load new credentials
kubectl rollout restart deployment/korap-korap-kalamar-full -n korap
```

### 4. Install with Example Index

For testing purposes:

```bash
helm install korap ./korap \
  --namespace korap \
  --set exampleIndex.enabled=true
```

### 5. Verify Installation

```bash
# Check pods
kubectl get pods -n korap

# Check secrets (OAuth credentials)
kubectl get secrets -n korap | grep super-client

# Check services
kubectl get svc -n korap

# Check volumes
kubectl get pvc -n korap

# View deployment notes
helm get notes korap -n korap
```

---

## üåê Accessing KorAP

### Port Forwarding

If not using Ingress:

```bash
kubectl port-forward svc/korap-korap-kalamar 64543:64543 -n korap
```

Then access: `http://localhost:64543`

### With Ingress

Enable and configure Ingress:

```bash
helm upgrade korap ./korap \
  --set 'ingress.enabled=true' \
  --set 'ingress.className=nginx' \
  --set 'ingress.hosts[0].host=korap.example.com' \
  --set 'ingress.hosts[0].paths[0].path=/' \
  --set 'ingress.hosts[0].paths[0].pathType=Prefix' \
  -n korap
```

Then access: `https://korap.example.com`

---

## ÔøΩ Authentication & Authorization

### Full Profile Auth Setup

The full profile supports OAuth2/LDAP authentication via Kustvakt. Authentication requires a `super_client_info` file containing OAuth client configuration.

### Creating the super_client_info File

The `super_client_info` file is a JSON file containing OAuth2 client credentials and Kustvakt configuration:

```json
{
  "client_id": "korap-client",
  "client_secret": "your-secret-key",
  "scope": "read write",
  "redirect_uri": "http://localhost:64543/oauth2/callback",
  "response_type": "code",
  "grant_type": "authorization_code"
}
```

**Or with more advanced settings:**

```json
{
  "client_id": "korap-client",
  "client_secret": "your-secret-key",
  "api_token": "optional-api-token",
  "host": "kustvakt-full:8089",
  "version": "1.0"
}
```

See [Kustvakt Documentation](https://github.com/KorAP/Kustvakt) for full configuration options.

### Creating the Kubernetes Secret

Once you have your `super_client_info` file, create a Kubernetes secret:

```bash
# Create secret from file
kubectl create secret generic korap-super-client \
  --from-file=super_client_info=./super_client_info \
  -n korap

# Verify secret was created
kubectl describe secret korap-super-client -n korap

# View secret contents (base64 encoded)
kubectl get secret korap-super-client -o jsonpath='{.data.super_client_info}' -n korap | base64 -d
```

### Enabling Auth in Full Profile

Reference the secret in your Helm deployment:

```bash
helm upgrade korap ./korap \
  --namespace korap \
  --set full.enabled=true \
  --set kalamarFull.enabled=true \
  --set kustvaktFull.enabled=true \
  --set 'full.superClientInfoSecretName=korap-super-client' \
  --install
```

This will:
1. Mount the secret into Kalamar full at `/kalamar/super_client_info`
2. Automatically enable the Kalamar Auth plugin
3. Enable OAuth2 authentication in the frontend

### Using Keycloak / OIDC instead of bundling OAuth credentials

If you operate a Keycloak (or other OIDC) provider you can configure Kalamar to use it directly. Use the `full.keycloak` values block for issuer and client credentials.

1) Create Secret for client secret (recommended):

```bash
kubectl create secret generic korap-keycloak-client-secret \
  --from-literal=client-secret='VERY_SECRET' -n korap
```

2) Enable Keycloak in Helm:

```bash
helm upgrade --install korap ./korap \
  --namespace korap \
  --set full.enabled=true \
  --set kalamarFull.enabled=true \
  --set 'full.keycloak.enabled=true' \
  --set 'full.keycloak.issuer=https://auth.example.com/realms/korap' \
  --set 'full.keycloak.clientId=korap-client' \
  --set 'full.keycloak.clientSecretSecretName=korap-keycloak-client-secret'
```

3) In Keycloak configure the client redirect URI to match `full.superClientInfo.clientRedirectUri` (e.g. `https://korap.example.com/oauth2/callback`).

Notes:
- `full.keycloak.clientSecretSecretName` keeps secrets out of `values.yaml` (recommended).
- You may supply explicit OIDC endpoint URLs (`authUrl`, `tokenUrl`, `userinfoUrl`, `jwksUri`) if discovery is not available.

### Updating Authentication Credentials

To update the OAuth credentials:

```bash
# Delete old secret
kubectl delete secret korap-super-client -n korap

# Create new secret with updated credentials
kubectl create secret generic korap-super-client \
  --from-file=super_client_info=./super_client_info \
  -n korap

# Restart Kalamar pod to reload credentials
kubectl rollout restart deployment korap-korap-kalamar-full -n korap
```

### Disabling Authentication

If you want to run full profile without authentication:

```bash
# Simply don't set superClientInfoSecretName
helm upgrade korap ./korap \
  --namespace korap \
  --set full.enabled=true \
  --set kalamarFull.enabled=true \
  --set kustvaktFull.enabled=true \
  --install
```

Kalamar will run without the Auth plugin and allow anonymous access.

---

## ÔøΩüìö Index Management

### Using Existing Index

If you have an existing corpus index on a PVC:

```bash
helm install korap ./korap \
  --set 'indexVolume.existingClaim=my-index-pvc' \
  -n korap
```

### Loading a New Index

1. Create PVC for index data
2. Copy index files to PVC
3. Reference PVC in values

```bash
# Create initial index PVC
kubectl create -f - <<EOF
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: korap-index
  namespace: korap
spec:
  accessModes: [ "ReadWriteOnce" ]
  resources:
    requests:
      storage: 20Gi
