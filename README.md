# KorAP Helm Chart

This Helm chart is a **production-ready Kubernetes conversion** of the [KorAP Docker Compose](https://github.com/KorAP/KorAP-Docker) deployment.

KorAP (Corpus Analysis Platform) is a modular system consisting of:
- **Kalamar** - Web-based frontend for corpus search and analysis
- **Kustvakt** - Backend API providing authentication, authorization, and policy management
- **Krill** - Index backend (managed via corpus data in attached volumes)

This chart provides flexible, profile-based deployments supporting lite and full configurations.

---

## üöÄ Features

‚úÖ **Complete Docker Compose Conversion**
- All services from the original compose.yaml
- Matching port configuration (Kalamar: 64543, Kustvakt: 8089)
- Correct image repositories (korap/)
- Kubernetes-compatible restart policies

‚úÖ **Profile-Based Deployment**
- **Lite Profile** - Single Kalamar & Kustvakt services (default)
- **Full Profile** - Enterprise setup with authentication plugins, LDAP support, dedicated data volumes
- **Example Profile** - Optional example index container for testing

‚úÖ **Volume Management**
- Shared index volume for lite and full profiles
- Separate data volumes for full profile (Kalamar & Kustvakt)
- Support for existing PVCs or automatic creation

‚úÖ **Production Ready**
- Initialization job for full profile configuration
- Health checks (readiness/liveness probes)
- Security context configuration
- Service accounts
- Optional Ingress support

‚úÖ **Flexible Configuration**
- Extensive values.yaml with 60+ configuration options
- Environment variable support for custom configuration
- Production configuration file support (full profile)

‚úÖ **Authentication Options**
- **Internal OAuth2** - Auto-generated super_client_info or custom configuration
- **Keycloak/OpenID Connect** - Full Keycloak integration with OIDC discovery
- **LDAP** - LDAP directory authentication support
- All authentication methods are optional and can be combined

---

## üì¶ Chart Structure

```
korap-helm/
‚îú‚îÄ‚îÄ Chart.yaml
‚îú‚îÄ‚îÄ README.md
‚îú‚îÄ‚îÄ IMPLEMENTATION.md
‚îú‚îÄ‚îÄ KEYCLOAK_SETUP.md
‚îú‚îÄ‚îÄ LICENSE
‚îú‚îÄ‚îÄ RANCHER_INTEGRATION.md
‚îú‚îÄ‚îÄ values-keycloak-example.yaml
‚îî‚îÄ‚îÄ charts/korap/
    ‚îú‚îÄ‚îÄ Chart.yaml
    ‚îú‚îÄ‚îÄ values.yaml
    ‚îú‚îÄ‚îÄ templates/
    ‚îÇ   ‚îú‚îÄ‚îÄ _helpers.tpl
    ‚îÇ   ‚îú‚îÄ‚îÄ serviceaccount.yaml
    ‚îÇ   ‚îú‚îÄ‚îÄ kalamar-deployment.yaml
    ‚îÇ   ‚îú‚îÄ‚îÄ kalamar-full-deployment.yaml
    ‚îÇ   ‚îú‚îÄ‚îÄ kalamar-configmap.yaml
    ‚îÇ   ‚îú‚îÄ‚îÄ kustvakt-deployment.yaml
    ‚îÇ   ‚îú‚îÄ‚îÄ kustvakt-full-deployment.yaml
    ‚îÇ   ‚îú‚îÄ‚îÄ example-index-deployment.yaml
    ‚îÇ   ‚îú‚îÄ‚îÄ full-init-job.yaml
    ‚îÇ   ‚îú‚îÄ‚îÄ ingress.yaml
    ‚îÇ   ‚îú‚îÄ‚îÄ keycloak-secret.yaml
    ‚îÇ   ‚îú‚îÄ‚îÄ super-client-info-secret.yaml
    ‚îÇ   ‚îú‚îÄ‚îÄ pvc-index.yaml
    ‚îÇ   ‚îú‚îÄ‚îÄ pvc-data.yaml
    ‚îÇ   ‚îú‚îÄ‚îÄ pvc-kustvakt-data.yaml
    ‚îÇ   ‚îú‚îÄ‚îÄ NOTES.txt
    ‚îÇ   ‚îî‚îÄ‚îÄ _helpers.tpl
```

---

## ‚öôÔ∏è Configuration

All deployment settings are controlled through `values.yaml` in the chart root directory.

### Service Configuration

```yaml
service:
  kalamar:
    port: 64543        # Kalamar web interface port
    type: ClusterIP
  kustvakt:
    port: 8089         # Kustvakt API port
    type: ClusterIP
```

### Volume Configuration

```yaml
indexVolume:
  size: 10Gi
  storageClassName: null    # Use default storage class
  existingClaim: null       # Or use existing PVC

full:
  dataVolume:
    enabled: false
    mountPath: /kalamar/data
    size: 50Gi
```

### Lite Profile (Default)

```yaml
kalamar:
  image: korap/kalamar:latest
  replicaCount: 1

kustvakt:
  image: korap/kustvakt:latest
```

### Full Profile

```yaml
full:
  enabled: false
  
kalamarFull:
  enabled: false
  image: korap/kalamar:latest

kustvaktFull:
  enabled: false
  image: korap/kustvakt:latest-full
  
# For authentication/LDAP:
full:
  superClientInfoSecretName: null
  kalamarProductionConf:
    enabled: false
    content: ""
```

### Example Profile

```yaml
exampleIndex:
  enabled: false
  image: korap/example-index:0.1
```

### Security & Restart Policies

```yaml
securityContext:
  runAsUser: 0          # Root user (required for full profile)
  runAsGroup: 0
  fsGroup: 0

restartPolicy: Always   # Kubernetes equivalent of Docker's "unless-stopped"
```

---

## üèÅ Installation

### Prerequisites

- Kubernetes 1.16+
- Helm 3.0+
- Sufficient storage for index volumes

### 1. Create Namespace

```bash
kubectl create namespace korap
```

### 2. Install Lite Profile

Basic KorAP deployment:

```bash
helm install korap ./korap \
  --namespace korap \
  --create-namespace
```

### 3. Install Full Profile

Enterprise setup with authentication **(auto-generated by default)**:

```bash
helm install korap ./korap \
  --namespace korap \
  --set full.enabled=true \
  --set kalamarFull.enabled=true \
  --set kustvaktFull.enabled=true \
  --set 'full.dataVolume.enabled=true'
```

**What happens automatically:**
- ‚úÖ OAuth2 `super_client_info` Secret is auto-generated with secure defaults
- ‚úÖ Client secret is 32-character random string
- ‚úÖ Kalamar Auth plugin is automatically enabled
- ‚úÖ Login/authentication ready to use immediately
- ‚úÖ All credentials stored securely in Kubernetes Secret

**To view the generated OAuth credentials:**

```bash
# Get the generated client secret
kubectl get secret korap-korap-super-client-info -o jsonpath='{.data.super_client_info}' -n korap | base64 -d
```

**Customize OAuth Configuration (optional):**

Override auto-generated defaults for your environment:

```bash
helm install korap ./korap \
  --namespace korap \
  --set full.enabled=true \
  --set kalamarFull.enabled=true \
  --set kustvaktFull.enabled=true \
  --set 'full.superClientInfo.clientId=my-korap' \
  --set 'full.superClientInfo.clientName=KorAP Production' \
  --set 'full.superClientInfo.clientRedirectUri=https://korap.example.com/oauth2/callback' \
  --set 'full.superClientInfo.clientSecret=your-custom-secret'
```

**Provide Your Own OAuth Client (optional):**

To use a pre-existing OAuth client configuration:

```bash
# Create secret with your super_client_info file
kubectl create secret generic korap-oauth \
  --from-file=super_client_info=./super_client_info \
  -n korap

# Reference it in deployment
helm install korap ./korap \
  --namespace korap \
  --set full.enabled=true \
  --set kalamarFull.enabled=true \
  --set kustvaktFull.enabled=true \
  --set 'full.superClientInfoSecretName=korap-oauth'
```

**Disable Authentication (optional):**

To run full profile without authentication:

```bash
helm install korap ./korap \
  --namespace korap \
  --set full.enabled=true \
  --set kalamarFull.enabled=true \
  --set kustvaktFull.enabled=true \
  --set 'full.superClientInfo.enabled=false'
```

**Update OAuth Configuration After Deployment:**

Edit the Secret to change credentials:

```bash
# Edit the secret directly
kubectl edit secret korap-korap-super-client-info -n korap

# Or replace it
kubectl delete secret korap-korap-super-client-info -n korap
kubectl create secret generic korap-korap-super-client-info \
  --from-file=super_client_info=/path/to/new/super_client_info \
  -n korap

# Restart Kalamar to load new credentials
kubectl rollout restart deployment/korap-korap-kalamar-full -n korap
```

### 4. Install with Example Index

For testing purposes:

```bash
helm install korap ./korap \
  --namespace korap \
  --set exampleIndex.enabled=true
```

### 5. Verify Installation

```bash
# Check pods
kubectl get pods -n korap

# Check secrets (OAuth credentials)
kubectl get secrets -n korap | grep super-client

# Check services
kubectl get svc -n korap

# Check volumes
kubectl get pvc -n korap

# View deployment notes
helm get notes korap -n korap
```

---

## üåê Accessing KorAP

### Port Forwarding

If not using Ingress:

```bash
kubectl port-forward svc/korap-korap-kalamar 64543:64543 -n korap
```

Then access: `http://localhost:64543`

### With Ingress

Enable and configure Ingress:

```bash
helm upgrade korap ./korap \
  --set 'ingress.enabled=true' \
  --set 'ingress.className=nginx' \
  --set 'ingress.hosts[0].host=korap.example.com' \
  --set 'ingress.hosts[0].paths[0].path=/' \
  --set 'ingress.hosts[0].paths[0].pathType=Prefix' \
  -n korap
```

Then access: `https://korap.example.com`

Note: by default the Ingress routes to the Kalamar service. When you enable the full profile with `kalamarFull.enabled=true` the chart's `ingress.yaml` automatically points the backend to the `-kalamar-full` service instead of `-kalamar`, so you do not need to change the Ingress manually.

---

## ÔøΩ Authentication & Authorization

This chart supports multiple authentication methods:

### 1. Keycloak/OpenID Connect (Recommended for External Auth)

For enterprise environments with existing Keycloak infrastructure:

```bash
helm install korap ./korap \
  --set keycloak.enabled=true \
  --set keycloak.authUrl="https://your-keycloak.com/realms/korap" \
  --set keycloak.tokenUrl="https://your-keycloak.com/realms/korap/protocol/openid-connect/token" \
  --set keycloak.issuer="https://your-keycloak.com/realms/korap" \
  --set keycloak.jwksUri="https://your-keycloak.com/realms/korap/protocol/openid-connect/certs" \
  --set keycloak.clientId="korap" \
  --set keycloak.clientSecret="YOUR-SECRET-HERE" \
  -n korap
```

**See [KEYCLOAK_SETUP.md](KEYCLOAK_SETUP.md) for complete setup instructions and [values-keycloak-example.yaml](values-keycloak-example.yaml) for reference configuration.**

### 2. Internal OAuth2 (super_client_info)

For self-managed OAuth2 without external provider:

#### Auto-Generated Credentials (Simplest)

```bash
helm install korap ./korap \
  --namespace korap \
  --set full.enabled=true \
  --set kalamarFull.enabled=true \
  --set kustvaktFull.enabled=true \
  --set 'full.superClientInfo.enabled=true'
```

**What happens automatically:**
- ‚úÖ OAuth2 `super_client_info` Secret is auto-generated with secure defaults
- ‚úÖ Client secret is 32-character random string
- ‚úÖ Kalamar Auth plugin is automatically enabled

#### Custom OAuth Configuration

The `super_client_info` file is a JSON file containing OAuth2 client credentials and Kustvakt configuration:

```json
{
  "client_id": "korap-client",
  "client_secret": "your-secret-key",
  "scope": "read write",
  "redirect_uri": "http://localhost:64543/oauth2/callback",
  "response_type": "code",
  "grant_type": "authorization_code"
}
```

Create a Kubernetes secret from your super_client_info file:

```bash
# Create secret from file
kubectl create secret generic korap-super-client \
  --from-file=super_client_info=./super_client_info \
  -n korap

# Reference it in deployment
helm install korap ./korap \
  --namespace korap \
  --set full.enabled=true \
  --set kalamarFull.enabled=true \
  --set kustvaktFull.enabled=true \
  --set 'full.superClientInfoSecretName=korap-super-client'
```

### 3. LDAP Authentication

For LDAP directory integration:

```bash
# Create secret from file
kubectl create secret generic korap-super-client \
  --from-file=super_client_info=./super_client_info \
  -n korap

# Verify secret was created
kubectl describe secret korap-super-client -n korap

# View secret contents (base64 encoded)
kubectl get secret korap-super-client -o jsonpath='{.data.super_client_info}' -n korap | base64 -d
```

### 3. LDAP Authentication

For LDAP directory integration:

```bash
helm install korap ./korap \
  --namespace korap \
  --set full.enabled=true \
  --set kustvaktFull.enabled=true \
  --set 'full.kustvaktLdap.enabled=true' \
  --set 'full.kustvaktLdap.host=ldap.example.com' \
  --set 'full.kustvaktLdap.port=389' \
  --set 'full.kustvaktLdap.searchBase=ou=users,dc=example,dc=com' \
  --set 'full.kustvaktLdap.sLoginDN=cn=admin,dc=example,dc=com' \
  --set 'full.kustvaktLdap.password=YOUR-LDAP-PASSWORD'
```

See the [values-keycloak-example.yaml](values-keycloak-example.yaml) file for complete LDAP configuration options.

### No Authentication (Disabled)

To run the full profile without any authentication:

```bash
helm install korap ./korap \
  --namespace korap \
  --set full.enabled=true \
  --set kalamarFull.enabled=true \
  --set kustvaktFull.enabled=true \
  --set 'full.superClientInfo.enabled=false'
```

Kalamar will run without the Auth plugin and allow anonymous access.

---

## üîê Authentication & Authorization

This chart supports multiple authentication methods:

### 1. Keycloak/OpenID Connect (Recommended for External Auth)

For enterprise environments with existing Keycloak infrastructure:

```bash
# 1) Create Secret for client secret (recommended):
kubectl create secret generic korap-keycloak-client-secret \
  --from-literal=client-secret='YOUR_SECRET_HERE' -n korap

# 2) Enable Keycloak in Helm:
helm upgrade --install korap ./korap \
  --namespace korap \
  --set full.enabled=true \
  --set kalamarFull.enabled=true \
  --set kustvaktFull.enabled=true \
  --set 'full.keycloak.enabled=true' \
  --set 'full.keycloak.issuer=https://auth.example.com/realms/korap' \
  --set 'full.keycloak.clientId=korap-client' \
  --set 'full.keycloak.clientSecretSecretName=korap-keycloak-client-secret'

# 3) In Keycloak configure the client redirect URI to match your deployment
# e.g. https://korap.example.com/oauth2/callback
```

**See [KEYCLOAK_SETUP.md](KEYCLOAK_SETUP.md) for complete setup instructions and [values-keycloak-example.yaml](values-keycloak-example.yaml) for reference configuration.**

Notes:
- `full.keycloak.clientSecretSecretName` keeps secrets out of `values.yaml` (recommended).
- You may supply explicit OIDC endpoint URLs (`authUrl`, `tokenUrl`, `userinfoUrl`, `jwksUri`) if discovery is not available.

### 2. Internal OAuth2 (super_client_info)

For self-managed OAuth2 without external provider:

#### Auto-Generated Credentials (Simplest)

```bash
helm install korap ./korap \
  --namespace korap \
  --set full.enabled=true \
  --set kalamarFull.enabled=true \
  --set kustvaktFull.enabled=true \
  --set 'full.superClientInfo.enabled=true'
```

**What happens automatically:**
- ‚úÖ OAuth2 `super_client_info` Secret is auto-generated with secure defaults
- ‚úÖ Client secret is 32-character random string
- ‚úÖ Kalamar Auth plugin is automatically enabled

#### Custom OAuth Configuration

```bash
# 1) Create secret with custom super_client_info file
kubectl create secret generic korap-super-client \
  --from-file=super_client_info=./super_client_info \
  -n korap

# 2) Reference it in deployment
helm install korap ./korap \
  --namespace korap \
  --set full.enabled=true \
  --set kalamarFull.enabled=true \
  --set kustvaktFull.enabled=true \
  --set 'full.superClientInfoSecretName=korap-super-client'
```

To update OAuth credentials:

```bash
# Delete old secret
kubectl delete secret korap-super-client -n korap

# Create new secret with updated credentials
kubectl create secret generic korap-super-client \
  --from-file=super_client_info=./super_client_info \
  -n korap

# Restart Kalamar pod to reload credentials
kubectl rollout restart deployment korap-korap-kalamar-full -n korap
```

### 3. LDAP Authentication

For LDAP directory integration:

```bash
helm install korap ./korap \
  --namespace korap \
  --set full.enabled=true \
  --set kustvaktFull.enabled=true \
  --set 'full.kustvaktLdap.enabled=true' \
  --set 'full.kustvaktLdap.host=ldap.example.com' \
  --set 'full.kustvaktLdap.port=389' \
  --set 'full.kustvaktLdap.searchBase=ou=users,dc=example,dc=com' \
  --set 'full.kustvaktLdap.sLoginDN=cn=admin,dc=example,dc=com' \
  --set 'full.kustvaktLdap.password=YOUR-LDAP-PASSWORD'
```

See the [values-keycloak-example.yaml](values-keycloak-example.yaml) file for complete LDAP configuration options.

---

## ÔøΩüìö Index Management

### Using Existing Index

If you have an existing corpus index on a PVC:

```bash
helm install korap ./korap \
  --set 'indexVolume.existingClaim=my-index-pvc' \
  -n korap
```

### Loading a New Index

1. Create PVC for index data
2. Copy index files to PVC
3. Reference PVC in values

```bash
# Create initial index PVC
kubectl create -f - <<EOF
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: korap-index
  namespace: korap
spec:
  accessModes: [ "ReadWriteOnce" ]
  resources:
    requests:
      storage: 20Gi
EOF
```

---

## üìñ Documentation

This repository includes comprehensive documentation for various deployment scenarios:

| File | Purpose |
|------|---------|
| [README.md](README.md) | This file - Overview and quick start (you are here) |
| [IMPLEMENTATION.md](IMPLEMENTATION.md) | Complete feature documentation and technical details |
| [KEYCLOAK_SETUP.md](KEYCLOAK_SETUP.md) | Keycloak integration setup guide with step-by-step instructions |
| [values-keycloak-example.yaml](values-keycloak-example.yaml) | Complete example values file with Keycloak configuration |
| [RANCHER_INTEGRATION.md](RANCHER_INTEGRATION.md) | Integration with Rancher for additional management features |

---

## üîó Quick Links

- **GitHub**: [KorAP](https://github.com/KorAP)
- **Kalamar**: [Frontend Repository](https://github.com/KorAP/Kalamar)
- **Kustvakt**: [Backend Repository](https://github.com/KorAP/Kustvakt)
- **Krill**: [Index Backend](https://github.com/KorAP/Krill)

---

## üìù License

This Helm chart is licensed under the Apache License 2.0. See [LICENSE](LICENSE) file for details.
